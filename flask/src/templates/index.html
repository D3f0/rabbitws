{% extends "base.html" %}


{% block content %}

<h3>Conexi√≥n a conector MQTT de RabbitMQ sobre WebSocket</h3>
<span id="status">Conectando...</span>
<pre id="log_area" style="height: 200px; border: 1px solid #dec; overflow-y: scroll;">

</pre>
{% endblock content %}


{% block navbar %}
<nav class="navbar navbar-default">
  <div class="container-fluid">
    <ul class="nav navbar-nav">
        <li class="active"><a href="#">MQTT Subscribe<span class="sr-only">(current)</span></a></li>
        <li><a href="/jupyter/">Jupyter</a></li>
        <li><a href="/rabbitmq/">RabbitMQ Admin</a></li>
  </div>
</nav>
{% endblock navbar %}


{% block scripts %}
    {{ super() }}
    <script type="text/javascript"
    src="{{ url_for('static', filename='bower/jQuery/dist/jquery.js') }}"></script>
    <script type="text/javascript"
    src="{{ url_for('static', filename='bower/paho.mqtt.js/src/mqttws31.js') }}"></script>

    <script type="text/javascript">

      $(function () {

          var $status = $('#status');
          var $log = $('#log_area');

          function log(_) {
            var args = [];
            for (var i=0; i<arguments.length; i++) {
              args.push(arguments[i]);
            }
            var txt = args.join(' ');
            console.log(arguments);
            $log.text($log.text()+txt+'\n');

          }
          window.log = log;

          var port = Number(location.port || 80);
          console.info(port);
          client = new Paho.MQTT.Client(
            location.hostname,
            Number(location.port || 80),
            "web_client_" + (Math.floor(Math.random() * 5000) + 1)
          );

          log("Connecting to: ", location.hostname, Number(location.port), "clientId");
          client.onConnectionLost = onConnectionLost;
          client.onMessageArrived = onMessageArrived;

          client.connect({
            onSuccess: onConnect,
            userName: "test",
            password: "secret"
          });

          function onConnect() {
            // Once a connection has been made, make a subscription and send a message.
            log("onConnect");
            $status.text("Conectado");
            client.subscribe("test");

            message = new Paho.MQTT.Message("this is payload");
            message.destinationName = "test";
            client.send(message);
            // window.CLIENT = client;
          };

          function onConnectionLost(responseObject) {
            $status.text("Desconectado");
            if (responseObject.errorCode !== 0) {
              log("onConnectionLost:"+responseObject.errorMessage);

              window.setTimeout(function () {
                log("Reconnecting...");
                client.connect({
                  onSuccess: onConnect
                });
              }, 1000);
            }

          };

          function onMessageArrived(message) {
            log("onMessageArrived:"+message.payloadString);
          };
      });
    </script>

{% endblock scripts %}
